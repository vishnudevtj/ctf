#include "libc.h"

// syscall
int read(int fd, char* buf, int len) {
  __asm__("mov rax, 0");
  __asm__("syscall");
}

int write(int fd, char* buf, int len) {
  __asm__("mov rax, 1");
  __asm__("syscall");
}

int open(char* filename, int flags) {
  __asm__("mov rax, 2");
  __asm__("syscall");
}

int close(int fd) {
  __asm__("mov rax, 3");
  __asm__("syscall");
}

uint64_t lseek(int fd, uint64_t offset, int whence) {
  __asm__("mov rax, 8");
  __asm__("syscall");
}
void exit(int status) {
  __asm__("mov rax, 60");
  __asm__("syscall");
}

int ioctl(unsigned int fd, unsigned int cmd, char* arg) {
  __asm__("mov rax, 16");
  __asm__("syscall");
}

int execve(char *filename, char *const argv[], char *const envp[]) {
  __asm__("mov rax, 59");
  __asm__("syscall");
}

void *mmap(void *addr, unsigned long length, int prot, int flags, int fd, unsigned long offset) {
  __asm__("mov r10, rcx");
  __asm__("mov rax, 9");
  __asm__("syscall");
}


int msgget(int key, int msgflg) {
  __asm__("mov rax, 68");
  __asm__("syscall");
}
int msgsnd(int msqid, void *msgp, unsigned long msgsz, int msgflg) {
  __asm__("mov rax, 69");
  __asm__("syscall");
}

int msgrcv(int msqid, void *msgp, unsigned long msgsz, long msgtyp,
           int msgflg){
  __asm__("mov rax, 70");
  __asm__("syscall");
}

int getuid()
{
  __asm__("mov rax, 102");
  __asm__("syscall");
}

int geteuid()
{
  __asm__("mov rax, 107");
  __asm__("syscall");
}


int setresuid(unsigned int ruid, unsigned int euid, unsigned int suid)
{
  __asm__("mov rax, 113");
  __asm__("syscall");
}

// helper
int strlen(char* string) {
  int len = 0;
  for (; *(string++) != '\x00'; len++) {}
  return len;
}

void puts(char* string) {
  int len = strlen(string);
  write(1, string, len);
}

char getchar()
{
  char c;
  read(0,&c,1);
  return c;
}
void putchar(int c)
{
  write(0,(char *)&c,1);
}
void strncpy(char * dest,char * src, int size)
{
  int i =0 ;
  while(*src && i < size)
    {
      *dest = *src;
      dest++;
      src++;
      i++;
    }
}

void memcpy(char * dest,char * src, int size)
{
  int i = 0 ;
  while(i < size)
    {
      *dest = *src;
      dest++;
      src++;
      i++;
    }
}

void * memset(char *s , int c ,unsigned int  n)
{
  int i=0;
  while(i<n)
    {
      *s=c;
      s++;
      i++;
    }
  return s-n;
}

char charset[0x10]="0123456789abcdef";

unsigned long hex(unsigned long value)
{
  int i=7;
  char * ptr =(char *) &value;
  putchar(charset[0]);
  putchar(0x78);
  while(i>=0) {
    putchar(charset[((unsigned short)ptr[i]>>4)%0x10]);
    putchar(charset[(unsigned short)ptr[i]%0x10]);
    i--;
  }
  return 0;
}

void hexdump(const unsigned char *x, unsigned long n) {
  char buf[3];
  buf[2] = ' ';

  for (unsigned long i = 0; i < n; ++i) {
    unsigned char b = x[i];
    buf[0] = "0123456789abcdef"[b >> 4];
    buf[1] = "0123456789abcdef"[b & 0xf];
    write(1, buf, sizeof(buf));
    if (i != 0 && i % 32 == 0) {
      putchar(0xa);
    }
  }
  putchar(0xa);
}

void log_ptr(char * str, void * addr){
  puts(str);
  hex((uint64_t)addr);
  putchar(0xa);
}
